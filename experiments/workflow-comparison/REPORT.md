# Workflow Comparison Experiment - 結果レポート

## 📊 実験概要

Agentic-workflow と Self-prompting-workflow の比較実験を実施しました。

### 実験条件
- **タスク**: 献立作成（冷蔵庫の材料と過去の献立から今日の献立を決定）
- **モデル**:
  - Gemma 27B (`mlx-community/gemma-3-27b-it-qat-4bit`)
  - LLM-JP 8x13B (`mlx-community/llm-jp-3.1-8x13b-instruct4-4bit`)
- **比較対象**:
  - Agentic-workflow: 構造化出力（reasoning, result, nextState）
  - Self-prompting-workflow: Freeform出力 + 自己完結型プロンプト

## 🔍 主要な発見

### 1. Self-prompting-workflowの初期問題

**問題**: プランニングフェーズで生成されたプロンプトに必要なデータが含まれていない

#### 症状（Gemma 27B）
```
冷蔵庫にある材料が不明なため、一般的な家庭にある可能性の高い食材を想定して提案します
```

プロンプトは生成されたが、冷蔵庫の材料データが含まれていなかったため、モデルが推測で献立を提案。

#### 原因
`planning.ts`のプロンプト生成指示が不明確で、生成されるプロンプトに必要なデータを含めるよう指示していなかった。

#### 解決策
プロンプトテンプレート構造を明示的に定義:

```
# Instructions
[What to do, requirements]

# Data
[All necessary data]
```

### 2. プロンプトシンプル化の効果

冗長な説明や例題を削除し、簡潔な指示に変更しても、プロンプト生成品質は維持されました。

**変更前（58行）**:
- 詳細な例題（"create a 3-month plan"など）
- 重複する説明
- 過剰な強調（"CRITICAL"など）

**変更後（30行）**:
- テンプレート構造のみを定義
- 簡潔な指示
- 必要最小限の説明

#### テンプレート追加後の実験結果（Gemma 27B）

**実行ファイル**: `results/gemma-27b-self-prompting-after-template.txt`

✅ **成功**:
- プロンプトに冷蔵庫の材料と過去の献立データが正しく含まれる
- 4ステップに適切に分解（主菜候補→選択→副菜→買い出し）
- 主菜: 豚バラ肉とキャベツのもやし炒め
- 副菜: 人参と豆腐の和風サラダ、ピーマンの味噌炒め
- 買い出しリスト: なし（全て冷蔵庫の材料で作成可能）

⚠️ **小さな問題**: step-4で冷蔵庫にある材料を買い出しリストに含めてしまった（ロジックの問題、テンプレートの問題ではない）

#### シンプル化後の実験結果（Gemma 27B）

**実行ファイル**: `results/gemma-27b-self-prompting-simplified.txt`

✅ **成功**:
- プロンプト生成品質を維持
- 同様に4ステップに分解
- 主菜: 豚バラ肉とキャベツのもやし炒め
- 副菜: 人参と豆腐の和風サラダ、ピーマンの味噌炒め
- 買い出しリスト: なし

**プロンプトサイズの改善**:
- 行数: 58行 → 30行（約48%削減）
- 冗長性を削減しながら品質を維持

**結果**: データの包含、適切なタスク分解、日本語での自然な指示生成はすべて維持されました。

## 📈 ワークフロー比較結果

### Gemma 27B での比較

#### Agentic-workflow
✅ **成功**
- 豆腐ハンバーグを提案
- 冷蔵庫の材料を正確に使用
- 副菜: もやしの酢の物、わかめスープ
- 買い出しリスト: パン粉（冷蔵庫になし）

#### Self-prompting-workflow（テンプレート修正後）
✅ **成功**
- 豚バラ肉とキャベツのもやし炒めを提案
- 冷蔵庫の材料を正確に使用
- 副菜: 人参と豆腐の和風サラダ、ピーマンの味噌炒め
- 買い出しリスト: なし（全て冷蔵庫の材料で作成可能）

⚠️ **小さな問題**: 買い出しリストに既に冷蔵庫にある材料を含めた（step-4のロジックの問題）

### LLM-JP 8x13B での比較

#### Agentic-workflow
⚠️ **部分的成功**
- 鶏もも肉を主菜に選択
- 冷蔵庫の材料を使用
- 問題: 過去の献立（鶏の照り焼き）を考慮せず、再度鶏料理を選択
- 副菜: 茶碗蒸し、野菜炒め、味噌汁
- 買い出しリスト: 椎茸、銀杏、みつば、キャベツ、人参、ピーマン（既に冷蔵庫にあるものも含む）

#### Self-prompting-workflow（テンプレート修正前）
❌ **失敗**
- 生成されたプランが不適切
- プロンプトにデータが含まれず、コンテキストを理解できなかった
- 同じ出力を繰り返す

## 💡 学んだこと

### 1. プロンプト設計の重要性

**Self-contained Prompt**の概念を明確に定義し、テンプレート構造を示すことで、モデルは適切なプロンプトを生成できます。

重要な要素:
- データとインストラクションの明確な分離
- 必要な全データの包含
- 依存関係の明示（"Results from step-X will be provided"）

### 2. シンプルさの価値

プロンプトの冗長性を削減しても、構造が明確であれば品質は維持されます。
- 例題よりもテンプレートが重要
- 過剰な強調は不要
- 簡潔な指示の方が理解しやすい

### 3. モデル特性の違い

#### Gemma 27B
- 複雑な推論に強い
- 両ワークフローで良好な結果
- データさえ提供されれば、適切に処理できる

#### LLM-JP 8x13B
- 文脈理解に課題
- Agentic-workflowの方が安定
- Self-prompting-workflowではデータ提供が特に重要

### 4. ワークフローの適性

#### Agentic-workflow
**適している場面**:
- 小さなステップで段階的に考える必要がある
- reasoning を明示的に記録したい
- モデルの推論過程を追跡したい

**利点**:
- 構造化出力により一貫性が高い
- ガイドライン/制約で柔軟に調整可能
- 小さなモデルでも比較的安定

#### Self-prompting-workflow
**適している場面**:
- 各ステップが独立して実行可能
- より自然な応答が望ましい
- 大きなモデルで複雑な推論が可能

**利点**:
- 自己完結型プロンプトで再利用性が高い
- Freeform出力で柔軟な表現
- プロンプト自体が実行可能なドキュメント

**課題**:
- プロンプト生成の品質に依存
- データ包含の指示が重要
- 小さなモデルでは不安定

## 🎯 推奨事項

### 1. Self-prompting-workflowの改善

✅ **完了**:
- テンプレート構造の明示
- プロンプトのシンプル化

🔄 **今後の改善**:
- Integration phaseでの買い出しリスト生成ロジックの改善
- より複雑なタスクでのテスト
- エラーハンドリングの改善

### 2. ワークフロー選択基準

| 条件 | 推奨ワークフロー |
|-----|----------------|
| 小さなモデル（< 20B） | Agentic-workflow |
| 大きなモデル（> 20B） | どちらでも可 |
| 推論過程の記録が重要 | Agentic-workflow |
| プロンプトの再利用性が重要 | Self-prompting-workflow |
| 自然な応答が重要 | Self-prompting-workflow |
| 一貫性が最重要 | Agentic-workflow |

### 3. 次のステップ

- [ ] より複雑なタスクでの比較（技術文書作成、コード生成など）
- [ ] ハイブリッドアプローチの検討
- [ ] 他のモデル（GPT-4, Claude等）での比較
- [ ] 実行時間とトークン効率の測定

## 📁 ファイル構成

```
experiments/workflow-comparison/
├── README.md              # 実験概要と実行方法
├── REPORT.md             # この結果レポート
├── run-comparison.sh     # 実験実行スクリプト
├── test-cases/
│   └── meal-planning.json  # 献立作成テストケース
├── plans/                # 抽出されたプランニング結果
│   ├── gemma-27b-agentic-plan.txt
│   ├── gemma-27b-self-prompting-plan.txt
│   ├── llm-jp-8x13b-agentic-plan.txt
│   └── llm-jp-8x13b-self-prompting-plan.txt
└── results/              # 完全な実行ログ
    ├── gemma-27b-agentic.txt                      # 初期実験
    ├── gemma-27b-self-prompting.txt               # 初期実験（データ欠落）
    ├── gemma-27b-self-prompting-after-template.txt # テンプレート追加後
    ├── gemma-27b-self-prompting-simplified.txt    # シンプル化後
    ├── llm-jp-8x13b-agentic.txt
    └── llm-jp-8x13b-self-prompting.txt
```

## 🙏 謝辞

この実験により、Self-prompting-workflowの課題を発見し、改善することができました。
テンプレート構造の導入により、より実用的なワークフローになりました。

# Agentic Workflow モデル比較実験 - 結果サマリー

**実験日**: 2025-11-17
**タスク**: 献立計画（Meal Planning） - 冷蔵庫の材料と過去の献立から夕飯の献立を検討
**ワークフロー**: Planning → Execution → Integration の3フェーズ

---

## 実験結果概要

| モデル | パラメータ | サイズ | 結果 | 最終献立 | 評価 |
|--------|-----------|--------|------|----------|------|
| **qwq-bakeneko-32b-4bit** | 32B | 17GB | ✅ **成功** | 鶏の唐揚げ | ⭐⭐⭐⭐⭐ |
| **gemma-3-27b-it-qat-4bit** | 27B | 16GB | ✅ **成功** | 豆腐と卵のあんかけ | ⭐⭐⭐ |
| **llm-jp-3.1-8x13b-instruct4-4bit** | 8x13B (MoE) | 38GB | ✅ **成功** | 鶏もも肉のごま照り焼き | ⭐⭐⭐ |
| **gemma-3n-E4B-it-lm-4bit** | 4B (実効) | 3.6GB | ✅ **成功** | 3つの候補提示 | ⭐⭐ |
| **granite-4.0-h-tiny-6bit-MLX** | 7B (1B実効, MoE) | 5.3GB | ❌ **失敗** | - | ⭐ |
| **granite-4.0-h-1b-4bit** | 1B | 0.8GB | ❌ **失敗** | - | ☆ |
| **gemma-3-270m-it-qat-4bit** | 270M | 0.3GB | ❌ **失敗** | - | ☆ |

**成功率**: 4/7 (57.1%)

---

## 詳細分析

### 🏆 成功モデル（4/7）

#### 1. qwq-bakeneko-32b (32B) - ⭐⭐⭐⭐⭐ 最優秀

**Planning Phase:**
- 4ステップの詳細な実行計画を生成
- 各ステップにdos/dontsを明確に記載

**Execution Phase:**
- `<think>`タグで思考過程が完全に可視化されている（推論特化モデルの特徴）
- Step 1: 主菜候補抽出（唐揚げ、麻婆豆腐）
- Step 2: 唐揚げを選定（豚肉連続使用を回避）
- Step 3: さっぱり系副菜3案（キャベツサラダ、人参ピーマン酢の物、もやしわかめナムル）
- Step 4: 材料確認、買い出しリスト不要

**Integration Phase:**
- 実用的で完成度の高い献立案
- 選定理由、過去献立との比較、栄養バランス、調理手順のポイントまで含む
- 非常に論理的で詳細な説明

**評価:**
- ✅ 過去献立を正しく考慮（豚肉連続使用を回避）
- ✅ 冷蔵庫の材料のみを使用
- ✅ 実用的な献立（鶏の唐揚げ + 副菜3品）
- ✅ 買い出しリスト不要
- ✅ 思考過程が完全に可視化

---

#### 2. gemma-27b (27B) - ⭐⭐⭐ 良好（品質に課題）

**Planning Phase:**
- 4ステップの計画を生成

**Execution Phase:**
- Step 1: 詳細な主菜候補をリストアップ（鶏、豚、卵料理）
- Step 2: 3つに絞り込み（鶏の唐揚げ、卵焼き、豆腐と卵のあんかけ）
- Step 3: 各候補に対する副菜提案
- Step 4: 買い出しリスト作成

**Integration Phase:**
- 最終決定: 豆腐と卵のあんかけ

**問題点:**
- ❌ 買い出しリストに「ほうれん草」「きのこ」（冷蔵庫にない材料を使用）
- ❌ 副菜に「ご飯」が含まれている（主食を副菜と誤認）
- ❌ 豆腐と卵のあんかけは主菜としてはやや物足りない
- ⚠️ タスク要求「冷蔵庫の材料から作れる主菜候補」に矛盾

**評価:**
- ✅ ワークフロー完了
- ⚠️ 過去献立を考慮
- ❌ 冷蔵庫にない材料を使用
- ❌ 主菜の選定が不適切

---

#### 3. llm-jp-8x13b (8x13B MoE) - ⭐⭐⭐ 良好（出力言語に課題）

**Planning Phase:**
- 4ステップの計画を生成

**Execution Phase:**
- 4ステップすべて完了
- 各ステップで主菜と副菜の候補を提案

**Integration Phase:**
- 最終決定: 鶏もも肉のごま照り焼き
- 副菜: もやしナムル、ほうれん草のおひたし

**問題点:**
- ❌ 副菜に「ほうれん草のおひたし」（ほうれん草は冷蔵庫にない）
- ❌ 「No additional shopping list was required」と記載（実際にはほうれん草が必要）
- ⚠️ 日本語特化モデルなのに出力が主に英語

**評価:**
- ✅ ワークフロー完了
- ✅ 実用的な主菜選定
- ❌ 材料の在庫確認が不正確
- ⚠️ 出力言語が不適切（日本語モデルなのに英語出力が多い）

---

#### 4. gemma-3n-4b (4B effective) - ⭐⭐ 可（在庫管理に課題）

**Planning Phase:**
- 3ステップの計画を生成（4ステップより簡略化）

**Execution Phase:**
- 3ステップすべて完了
- 3つの主菜候補を提示（豚肉とキャベツの味噌炒め、豚肉と豆腐の麻婆豆腐、鶏肉の唐揚げ）

**Integration Phase:**
- 3つの献立案を並列で提示（最終的に1つに絞り込まず）

**問題点:**
- ❌ 買い出しリストに「卵」「豆腐」（冷蔵庫に「卵 6個」「豆腐 1丁」があるのに）
- ❌ 「きゅうり」は正しく識別（冷蔵庫にない）
- ⚠️ 最終的に献立を1つに絞り込んでいない

**評価:**
- ✅ ワークフロー完了
- ✅ 実用的な主菜候補
- ❌ 材料の在庫確認が完全に誤っている
- ⚠️ タスク完了度が不十分（最終決定していない）

---

### ❌ 失敗モデル（3/7）

#### 5. granite-tiny-7b (7B/1B effective MoE) - ⭐ JSON生成失敗

**失敗内容:**
- Planning phaseでエラー: `Invalid plan structure: steps is not an array`

**原因:**
- JSONスキーマ定義を出力してしまった
- 実際のデータ（steps配列）を生成できなかった
- 出力例: `{"type":"object","properties":{"steps":{"type":"array",...}}}`
  - これはスキーマ定義であって、実際のデータではない

**評価:**
- ❌ Planning phaseで完全に失敗
- ❌ JSON構造化出力能力の欠如
- ⚠️ MoE構造（1B実効）では不十分

---

#### 6. granite-1b (1B) - ☆ 完全失敗

**失敗内容:**
- Planning phaseでエラー: `Planning did not return structured output`

**原因:**
- 完全に意味不明な出力
- "The following instructions describes the purpose of the code snippet." の無限ループ
- JSON生成能力が完全に欠如

**評価:**
- ❌ Planning phaseで完全に失敗
- ❌ タスク理解能力の欠如
- ❌ 1Bモデルでは Agentic Workflow は実行不可能

---

#### 7. gemma-270m (270M) - ☆ 完全失敗

**失敗内容:**
- Planning phaseでエラー: `Planning did not return structured output`

**原因:**
- granite-1bと同じ、完全に意味不明な出力
- "The following instructions describes..." の繰り返し
- JSON生成能力が完全に欠如

**評価:**
- ❌ Planning phaseで完全に失敗
- ❌ タスク理解能力の欠如
- ❌ 270Mモデルでは Agentic Workflow は実行不可能

---

## 重要な発見

### 1. モデルサイズの閾値

**4B以上**: ワークフローを完了可能（成功率 100%）
- qwq-bakeneko-32b (32B) ✅
- gemma-27b (27B) ✅
- llm-jp-8x13b (8x13B MoE) ✅
- gemma-3n-4b (4B effective) ✅

**1B以下**: ワークフローを完了不可能（成功率 0%）
- granite-tiny-7b (1B effective MoE) ❌
- granite-1b (1B) ❌
- gemma-270m (270M) ❌

**閾値**: **実効パラメータ4B以上**が Agentic Workflow の実行に必要

---

### 2. JSON構造化出力能力

| モデル | JSON生成 | 品質 |
|--------|----------|------|
| qwq-bakeneko-32b | ✅ 完璧 | 高品質、論理的 |
| gemma-27b | ✅ 完璧 | 品質に課題あり |
| llm-jp-8x13b | ✅ 完璧 | 品質に課題あり |
| gemma-3n-4b | ✅ 完璧 | 品質に課題あり |
| granite-tiny-7b | ❌ スキーマ定義のみ | - |
| granite-1b | ❌ 生成不可 | - |
| gemma-270m | ❌ 生成不可 | - |

**結論**: 4B以上のモデルはJSON構造化出力が可能、1B以下は不可能

---

### 3. タスク品質の評価

#### 過去献立の考慮

| モデル | 評価 | 詳細 |
|--------|------|------|
| qwq-bakeneko-32b | ✅ 優秀 | 豚肉連続使用を正しく回避、鶏肉の調理法を変更 |
| gemma-27b | ✅ 良好 | 考慮しているが、選定が不適切 |
| llm-jp-8x13b | ✅ 良好 | 考慮している |
| gemma-3n-4b | ✅ 良好 | 考慮している |

#### 材料在庫の正確性

| モデル | 評価 | 問題点 |
|--------|------|--------|
| qwq-bakeneko-32b | ✅ 完璧 | 冷蔵庫の材料のみを使用、買い出しリスト不要 |
| gemma-27b | ❌ 不良 | ほうれん草・きのこ（冷蔵庫にない）を使用 |
| llm-jp-8x13b | ❌ 不良 | ほうれん草（冷蔵庫にない）を使用、買い出しリスト不要と誤認 |
| gemma-3n-4b | ❌ 不良 | 卵・豆腐（冷蔵庫にある）を買い出しリストに追加 |

**問題**: 中規模モデル（4B-27B）は材料在庫の正確な把握に課題

#### 実用性

| モデル | 主菜 | 実用性 |
|--------|------|--------|
| qwq-bakeneko-32b | 鶏の唐揚げ | ✅ 高い（夕飯の主菜として適切） |
| gemma-27b | 豆腐と卵のあんかけ | ⚠️ 低い（主菜として物足りない） |
| llm-jp-8x13b | 鶏もも肉のごま照り焼き | ✅ 高い |
| gemma-3n-4b | 3つの候補提示 | ⚠️ 中程度（最終決定していない） |

---

### 4. 推論過程の可視化

**qwq-bakeneko-32b のみ**: `<think>`タグで思考過程が完全に可視化
- Planning phase: 献立選定の論理的思考プロセス
- Execution phase: 各ステップでの判断根拠
- Integration phase: 最終統合の思考過程

**他のモデル**: 思考過程の出力なし

**価値**: デバッグ、品質評価、説明可能性の向上に非常に有効

---

### 5. 出力言語の問題

**llm-jp-8x13b**: 日本語特化モデルなのに出力が主に英語
- Planning phase: 日本語でプラン生成
- Execution phase: 主に英語で実行結果を出力
- Integration phase: 英語と日本語が混在

**原因推測**:
- Chat APIモデルとして最適化されている可能性
- 英語プロンプトへの反応性が高い
- 日本語特化の調整が不十分

---

## パフォーマンス比較

### ファイルサイズ（出力詳細度の指標）

| モデル | ファイルサイズ | 評価 |
|--------|--------------|------|
| gemma-27b | 50K | 最も詳細 |
| qwq-bakeneko-32b | 47K | 非常に詳細（思考過程を含む） |
| llm-jp-8x13b | 41K | 詳細 |
| gemma-3n-4b | 41K | 詳細 |
| gemma-270m | 24K | 中程度（失敗） |
| granite-tiny-7b | 17K | 少ない（失敗） |
| granite-1b | 13K | 最も少ない（失敗） |

**傾向**: 大規模モデルほど詳細で豊富な出力を生成

---

## 総合評価とランキング

### S Tier（最優秀）
1. **qwq-bakeneko-32b** (32B, 17GB)
   - 完璧なワークフロー実行
   - 思考過程の可視化
   - 実用的で論理的な献立
   - 材料在庫の正確な把握
   - **推奨用途**: 本番環境、高品質な出力が必要な場合

### A Tier（優秀）
- なし

### B Tier（良好）
2. **llm-jp-8x13b** (8x13B MoE, 38GB)
   - ワークフロー完了
   - 実用的な主菜選定
   - 材料在庫確認に課題
   - 出力言語の問題
   - **推奨用途**: 日本語タスク、ある程度の品質が許容される場合

3. **gemma-27b** (27B, 16GB)
   - ワークフロー完了
   - 主菜選定と材料管理に課題
   - **推奨用途**: 実験用途、品質チェックが可能な場合

### C Tier（可）
4. **gemma-3n-4b** (4B effective, 3.6GB)
   - ワークフロー完了
   - 材料在庫確認が完全に誤っている
   - 最終決定が不完全
   - **推奨用途**: リソース制約がある場合の実験用途

### D Tier（不可）
5. **granite-tiny-7b** (1B effective MoE, 5.3GB)
   - JSON生成失敗
   - **推奨用途**: なし（Agentic Workflow 不可）

6. **granite-1b** (1B, 0.8GB)
   - 完全失敗
   - **推奨用途**: なし（Agentic Workflow 不可）

7. **gemma-270m** (270M, 0.3GB)
   - 完全失敗
   - **推奨用途**: なし（Agentic Workflow 不可）

---

## 結論

### Agentic Workflow 実行の必要条件
1. **最小モデルサイズ**: 実効パラメータ4B以上
2. **JSON構造化出力能力**: 必須
3. **タスク理解能力**: Planning phaseでの適切な分解能力

### 推奨モデル選定基準

#### 高品質が必要な場合
- **qwq-bakeneko-32b** (32B, 17GB)
- 完璧な実行、思考過程の可視化、実用的な出力

#### バランス重視の場合
- **llm-jp-8x13b** (8x13B MoE, 38GB)
- 日本語タスクに適している
- ある程度の品質が許容される場合

#### リソース制約がある場合
- **gemma-3n-4b** (4B effective, 3.6GB)
- 最小限の機能を提供
- 品質には期待しない

### 今後の改善点

1. **中規模モデルの材料在庫管理**
   - プロンプト改善: 材料リストとの照合を明確に指示
   - Few-shot例の追加: 正しい在庫確認の例を提示

2. **日本語モデルの出力言語制御**
   - システムプロンプトで出力言語を明示
   - 日本語での応答を強く推奨する指示を追加

3. **小規模モデルの活用可能性**
   - 1B以下のモデルでは Agentic Workflow は不可能
   - 代替アプローチ: シンプルなタスクへの分解、事前定義されたフローの利用

4. **Granite モデルの課題**
   - JSON生成能力の根本的な問題
   - Fine-tuningまたはプロンプト工夫が必要

---

**実験完了日時**: 2025-11-17
**総実験時間**: 全7モデルで約6分（推定）
**評価者**: Claude Code (Sonnet 4.5)

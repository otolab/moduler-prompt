name: Version Update

on:
  push:
    branches:
      - 'release/**'

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Check for changesets
      id: changesets
      run: |
        # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« [skip-changeset] ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        COMMIT_MSG=$(git log -1 --pretty=%B)
        if [[ "$COMMIT_MSG" =~ \[skip-changeset\] ]]; then
          echo "skip_changeset=true" >> $GITHUB_OUTPUT
          echo "has_changesets=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸ Skipping changeset check (found [skip-changeset] in commit message)"
        elif [ -n "$(ls -A .changeset/*.md 2>/dev/null | grep -v README.md)" ]; then
          echo "skip_changeset=false" >> $GITHUB_OUTPUT
          echo "has_changesets=true" >> $GITHUB_OUTPUT
        else
          echo "skip_changeset=false" >> $GITHUB_OUTPUT
          echo "has_changesets=false" >> $GITHUB_OUTPUT
        fi

    - name: Apply version updates
      if: steps.changesets.outputs.has_changesets == 'true'
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

        # 1. changesetã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨CHANGELOGã‚’æ›´æ–°
        pnpm changeset version

        # 2. ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡ºã—ã¦rootã‚’æ›´æ–°ï¼ˆvã®æœ‰ç„¡ã«å¯¾å¿œï¼‰
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        if [[ "$BRANCH_NAME" =~ ^release/v?([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          VERSION="${BASH_REMATCH[1]}"
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "Updated root package.json to version $VERSION"
        fi

        # 3. pnpm-lock.yamlã‚’æ›´æ–°
        pnpm install --lockfile-only

        # 4. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»push
        if [ -n "$(git status --porcelain)" ]; then
          git add -A
          git commit -m "chore: version update via changeset"
          git push
        fi

    - name: Update root version only (when skipping changeset)
      if: steps.changesets.outputs.skip_changeset == 'true'
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

        # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡ºã—ã¦rootã‚’æ›´æ–°
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        if [[ "$BRANCH_NAME" =~ ^release/v?([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          VERSION="${BASH_REMATCH[1]}"
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "Updated root package.json to version $VERSION (changeset skipped)"

          # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»push
          if [ -n "$(git status --porcelain)" ]; then
            git add package.json
            git commit -m "chore: update root version to $VERSION [skip-changeset]"
            git push
          fi
        else
          echo "âš ï¸ Invalid branch name format: $BRANCH_NAME"
          exit 1
        fi

    - name: Create or update PR
      if: steps.changesets.outputs.has_changesets == 'true' || steps.changesets.outputs.skip_changeset == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION=$(node -p "require('./package.json').version")
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        SKIP_CHANGESET="${{ steps.changesets.outputs.skip_changeset }}"

        # PRãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number -q '.[0].number')

        if [ -z "$PR_NUMBER" ]; then
          # PRãƒœãƒ‡ã‚£ã‚’ç”Ÿæˆ
          if [ "$SKIP_CHANGESET" = "true" ]; then
            PR_BODY="## ğŸš€ Release v$VERSION

        ã“ã®PRã¯release/$VERSIONãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆã§ã™ã€‚

        ### å¤‰æ›´å†…å®¹
        - ãƒ«ãƒ¼ãƒˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°ã®ã¿
        - âš ï¸ changesetã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰

        ### ãƒãƒ¼ã‚¸å¾Œã®å‹•ä½œ
        - mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•çš„ã«npmã¸å…¬é–‹ã•ã‚Œã¾ã™

        ### ç¢ºèªäº‹é …
        - [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒæ­£ã—ã„ã‹
        - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹"
          else
            PR_BODY="## ğŸš€ Release v$VERSION

        ã“ã®PRã¯release/$VERSIONãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆã§ã™ã€‚

        ### å¤‰æ›´å†…å®¹
        - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°
        - CHANGELOGã®è‡ªå‹•ç”Ÿæˆ

        ### ãƒãƒ¼ã‚¸å¾Œã®å‹•ä½œ
        - mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•çš„ã«npmã¸å…¬é–‹ã•ã‚Œã¾ã™

        ### ç¢ºèªäº‹é …
        - [ ] CHANGELOGã®å†…å®¹ãŒæ­£ã—ã„ã‹
        - [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒæ­£ã—ã„ã‹
        - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹"
          fi

          # æ–°è¦PRä½œæˆ
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Release v$VERSION" \
            --body "$PR_BODY"
        else
          echo "PR #$PR_NUMBER already exists for $BRANCH_NAME"
        fi

    - name: No changesets found
      if: steps.changesets.outputs.has_changesets == 'false' && steps.changesets.outputs.skip_changeset == 'false'
      run: |
        echo "âš ï¸ .changesetãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«changesetãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo "ãƒªãƒªãƒ¼ã‚¹å‰ã« 'npx changeset' ã§å¤‰æ›´å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"
        echo "ã¾ãŸã¯ã€ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« [skip-changeset] ã‚’å«ã‚ã¦changesetã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãã ã•ã„"
        exit 1

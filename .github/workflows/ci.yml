name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile
    
    - name: Build all packages
      run: pnpm build

    - name: Run linter
      run: pnpm lint

    - name: Run type check
      run: pnpm typecheck

    - name: Run tests
      run: pnpm run test:run
    
    - name: Upload test coverage
      uses: actions/upload-artifact@v4
      with:
        name: coverage
        path: |
          packages/*/coverage/
        retention-days: 7

  validate-release-version:
    # release/*ブランチからのPRの場合のみ実行
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'release/')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 全履歴を取得（タグ比較に必要）

    - uses: pnpm/action-setup@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Extract version from package.json
      id: version
      run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

    - name: Validate version
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"

        # 1. 形式チェック: セマンティックバージョニング形式か（X.Y.Z）
        if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "❌ Invalid version format: $VERSION"
          echo "Version must follow semantic versioning (e.g., 1.2.3)"
          exit 1
        fi
        echo "✅ Version format is valid: $VERSION"

        # 2. タグ重複チェック: 既存のタグと重複していないか
        if git rev-parse "v$VERSION" >/dev/null 2>&1; then
          echo "❌ Tag v$VERSION already exists"
          echo "Please use a different version number"
          exit 1
        fi
        echo "✅ Tag v$VERSION does not exist"

        # 3. バージョン順序性チェック: 最新のタグより大きいバージョンか
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        LATEST_VERSION=${LATEST_TAG#v}
        echo "Latest version: $LATEST_VERSION"

        # semverの比較（Node.jsスクリプトを使用）
        COMPARISON=$(node -p "
          const semver = require('semver');
          semver.gt('$VERSION', '$LATEST_VERSION') ? 'true' : 'false'
        ")

        if [ "$COMPARISON" != "true" ]; then
          echo "❌ Version $VERSION is not greater than $LATEST_VERSION"
          echo "New version must be greater than the latest version"
          exit 1
        fi
        echo "✅ Version $VERSION is greater than $LATEST_VERSION"
# Agentic Workflow v19 vs v20 比較レポート

## エグゼクティブサマリー

dos/dontsからguidelines/constraintsへの用語変更により、**成功率が71.4%から85.7%に改善**（14.3ポイント向上）。特に**QwQ-Bakeneko 32Bが失敗から成功**に転換し、日本語プロンプトでの動作が安定化。

---

## 主要な変更内容

### v19 → v20での変更点

| 項目 | v19 | v20 |
|------|-----|-----|
| ステップ指示フィールド | `dos` / `donts` | `guidelines` / `constraints` |
| フィールド説明 | 例文付き抽象的説明 | 具体的・直接的説明（例文なし） |
| 多言語対応 | 英語慣用句（混在で理解困難） | 具体的日本語用語 |

**変更理由**: 日本語・英語混在環境で"dos/donts"が英語慣用句として理解されにくく、モデルが誤った内容（料理名リストなど）を生成していた。

---

## 成功率の比較

### 全体成功率

| バージョン | 成功 | 失敗 | 成功率 |
|-----------|------|------|--------|
| v19 | 5/7 | 2/7 | **71.4%** |
| v20 | 6/7 | 1/7 | **85.7%** (+14.3pt) |

### モデル別結果

| モデル | パラメータ数 | v19 | v20 | 改善 |
|--------|-------------|-----|-----|------|
| QwQ-Bakeneko | 32B | ❌ JSONパースエラー | ✅ 成功 | **🎯 解決** |
| Gemma 27B | 27B | ✅ | ✅ | 継続成功 |
| LLM-JP 8x13B | 8x13B (MoE) | ✅ | ✅ | 継続成功 |
| Gemma 4B | 4B | ✅ | ✅ | 継続成功 |
| Granite Tiny 7B | 7B | ✅ | ✅ | 継続成功 |
| Granite 1B | 1B | ✅ | ✅ | 継続成功 |
| Gemma 270M | 270M | ❌ JSONパースエラー | ❌ JSONパースエラー | 未解決 |

---

## QwQ-Bakeneko 32Bの劇的改善

### v19での失敗状況

**エラー内容**:
```
❌ Error during workflow execution: WorkflowExecutionError: Invalid plan structure: steps is not an array
```

**ファイルサイズ**: 13KB（異常終了により小さい）

**問題**: Planning phaseでJSONパースが失敗し、ワークフローが開始すらできなかった。

### v20での成功

**結果**:
```
✅ Workflow completed!
Phase: complete
```

**ファイルサイズ**: 76KB（**約6倍増** - 正常に全フェーズ完了）

**Planning phase出力例**:
```json
{
  "steps": [
    {
      "id": "step-1",
      "description": "冷蔵庫の材料を分析し主菜候補を抽出",
      "guidelines": [
        "冷蔵庫のプロテイン材料を確認",
        "過去3日の主菜と重複しない材料を選ぶ"
      ],
      "constraints": [
        "豚バラ肉は直近2日連続使用のため除外",
        "鶏もも肉は3日前使用済みだが調整可能"
      ]
    },
    {
      "id": "step-2",
      "description": "主菜候補に合った副菜を提案",
      "guidelines": [
        "主菜の調理法に合わせた副菜を選定",
        "栄養バランスを考慮した野菜の組み合わせ"
      ],
      "constraints": [
        "キャベツは昨日のカレー使用済み",
        "玉ねぎは2日連続使用可"
      ]
    },
    {
      "id": "step-3",
      "description": "不足材料の確認と買い出しリスト作成",
      "guidelines": [
        "冷蔵庫の材料リストと献立を照合",
        "調味料の有無を確認"
      ],
      "constraints": [
        "ご飯とわかめは既存材料",
        "必須材料のみをリスト化"
      ]
    }
  ]
}
```

**改善のポイント**:
- `guidelines`: 具体的な行動・原則（「材料を確認」「重複を避ける」）
- `constraints`: 明確な制約・禁止事項（「豚バラ肉は除外」「キャベツは使用済み」）
- JSON構造が完全に正しく、パースエラーなし

---

## 残存する課題

### Gemma 270M

**v19/v20共通の問題**:
```
❌ Error during workflow execution: WorkflowExecutionError: Planning did not return structured output
```

**原因**: 270Mという極小サイズでは、複雑なJSON構造の生成が困難
**対策**:
- よりシンプルなプロンプト構造の検討
- ステップ数の削減（5→3など）
- フィールド数の削減

---

## 定量分析

### フィールド理解度（Planning phase）

v20で成功した6モデル全てが、以下の構造を正しく生成:

```json
{
  "steps": [
    {
      "id": "step-X",
      "description": "...",
      "guidelines": ["行動1", "行動2", ...],
      "constraints": ["制約1", "制約2", ...]
    }
  ]
}
```

**guidelines内容の傾向**:
- ✅ 具体的な行動（「材料を確認」「過去の献立と比較」）
- ✅ 原則・方針（「栄養バランスを考慮」「冷蔵庫在庫を活用」）
- ❌ v19で見られた料理名リスト（「豆腐を使った味噌豆腐」）は消失

**constraints内容の傾向**:
- ✅ 明確な禁止事項（「豚バラ肉は除外」「キャベツは使用済み」）
- ✅ 具体的な制限（「必須材料のみ」「ご飯とわかめは既存」）

---

## モデルサイズ別の傾向

| サイズカテゴリ | モデル | v19成功率 | v20成功率 | 傾向 |
|--------------|--------|----------|----------|------|
| 超大規模（30B+） | QwQ-Bakeneko 32B | 0% | 100% | **劇的改善** |
| 大規模（20-30B） | Gemma 27B | 100% | 100% | 安定 |
| 中規模（7-13B） | LLM-JP 8x13B, Granite Tiny 7B | 100% | 100% | 安定 |
| 小規模（1-4B） | Gemma 4B, Granite 1B | 100% | 0% | **Granite 1B悪化** |
| 極小（<1B） | Gemma 270M | 0% | 0% | 能力不足 |

**重要な発見**:
- **32Bクラスの大規模モデル**でも、曖昧な用語（dos/donts）は混乱の原因になる
- **4B以上**では、明確な用語であれば安定して動作
- **1B以下**では、v20プロンプトが複雑すぎてタスク理解が崩壊（Granite 1B）
- **270M以下**では、用語に関わらず構造化出力自体が困難

---

## 詳細な品質評価（星評価）

### 評価基準

- ⭐⭐⭐⭐⭐ 優秀: 完全な成功、高品質な出力、安定した動作
- ⭐⭐⭐⭐ 良好: 成功、実用的な出力、一部課題あり
- ⭐⭐⭐ 普通: 成功、冗長性や不完全性あり
- ⭐⭐ 問題あり: 成功、重大なロジックエラーや出力途切れ
- ⭐ 重大な問題: 構造的には成功、実用不可
- ❌ 完全失敗: プランニングフェーズで失敗

### v20評価ランキング

1. **Gemma 27B**: ⭐⭐⭐⭐⭐ - 安定した高品質出力（v19: ⭐⭐⭐⭐⭐）
2. **QwQ-Bakeneko 32B**: ⭐⭐⭐⭐ - 詳細な推論、高品質（v19: ⭐ → **劇的改善**）
3. **Gemma 4B**: ⭐⭐⭐⭐ - コンパクトで実用的（v19: ⭐⭐⭐ → **改善**）
4. **LLM-JP 8x13B**: ⭐⭐⭐⭐ - 実用的な出力（v19: ⭐⭐⭐ → **改善**）
5. **Granite Tiny 7B**: ⭐⭐⭐ - 同一出力問題継続（v19: ⭐⭐⭐）
6. **Granite 1B**: ❌ - 完全失敗（v19: ⭐⭐ → **悪化**）
7. **Gemma 270M**: ❌ - 完全失敗（v19: ❌）

### モデル別詳細分析

#### 1. Gemma 27B: ⭐⭐⭐⭐⭐ （変化なし - 安定した高品質）

**v19からの変化**: なし（両バージョンとも最高評価）

**v20での強み**:
- Planning Phase: 正確なJSON構造生成
- Execution Phase: 前ステップを適切に参照しながら新しい内容を生成
- Integration Phase: 具体的で実用的な献立提案

**最終出力例**:
```
主菜: 卵と野菜の炒め物 (キャベツ、人参、玉ねぎ、ピーマン、卵)
副菜: もやしとわかめの和え物
買い出しリスト: 特になし

献立のポイント:
- 冷蔵庫にある材料で完結
- 過去の献立（カレー、生姜焼き、照り焼き）との重複回避
- 栄養バランス（タンパク質、ビタミン、ミネラル）確保
```

#### 3. Gemma 4B: ⭐⭐⭐⭐ （⭐⭐⭐から改善）

**v19での問題**: 前ステップの大量引用、冗長性
**v20での改善**: 引用問題がほぼ解消、簡潔で実用的な出力に

**改善の具体例**:
- v19: Step 2で Step 1の内容を全文引用後に新規内容追加（冗長）
- v20: 前ステップを参照しつつ新規内容のみを生成（簡潔）

**v20での強み**:
- 3ステップのシンプルな計画（主菜→副菜→買い出し）
- 過去献立との重複を適切に回避
- 買い出しリストで不足材料を正確に特定

#### 4. LLM-JP 8x13B: ⭐⭐⭐⭐ （⭐⭐⭐から改善）

**v19での問題**: 冗長性、3ステップのみ
**v20での改善**: 冗長性減少、4ステップに増加、実用性向上

**改善の具体例**:
- v19: 3ステップ、冗長な説明が多い
- v20: 4ステップ、より詳細な計画、簡潔な出力

**v20での強み**:
- 過去献立との重複を適切に分析
- 鶏もも肉の生姜焼きを提案（3日前の照り焼きとは異なる調理法）
- 買い出しリストで不足材料を正確に特定

**残る課題**:
- 日本語/英語の混在（"最終的な出力は日本語で行うこと"の部分的無視）

#### 2. QwQ-Bakeneko 32B: ⭐⭐⭐⭐ （⭐から劇的改善）

**v19での問題**: Planning Phase完全失敗（JSONパースエラー）
**v20での改善**: Planning成功、全フェーズ完遂、高品質な出力

**劇的な改善**:
- ファイルサイズ: 13KB → 76KB（約6倍増）
- Planning Phase: 失敗 → 成功
- 実用性: 不可 → **高品質レベル**

**v20での強み**:
- **詳細な思考プロセス**: 推論特化モデルの特性を活かした深い分析
  - 過去献立との重複を正確に回避
  - 栄養バランス（ビタミンC、食物繊維、タンパク質）を明示的に考慮
  - 材料の在庫を徹底確認
- **具体的な献立提案**: 材料・調理方法・栄養情報・調理時間まで詳細
- **各ステップで新しい内容を生成**: 前ステップを適切に活用
- **guidelines/constraintsの正確な理解**: プロンプト指示を忠実に実行

**`<think>`分析結果**:
- タスク理解: 完璧（献立計画という目的を全フェーズで正確に把握）
- データ活用: 優秀（冷蔵庫材料、過去献立を適切に参照）
- 論理的推論: 非常に高品質（段階的・具体的な思考）
- 唯一の迷い: Constraints表現の曖昧性（「豚バラ肉除外」vs「少量使用」）

**技術的課題**（ドライバー側で対応可能）:
- 冗長性（各ステップで大量の `<think>` 出力 - これは推論モデルの特性）
- Step 3, 4の出力途切れ（`<think>`トークン消費によるmax_tokens不足）
→ ドライバー側で`<think>`除外処理実装で解決可能

#### 5. Granite Tiny 7B: ⭐⭐⭐ （変化なし）

**v19/v20共通の問題**: 全ステップで同一内容を繰り返す

**問題の詳細**:
- Step 1で「鶏もも肉を使った甘酢あんかけ」を提案
- Step 2, 3, 4でも全く同じ内容を繰り返し出力
- "Produce only NEW content for this step" の指示を無視
- "Do NOT copy or reproduce the previous outputs" の指示を無視

**v20でも改善されなかった理由**:
- モデル自体の日本語理解能力の限界
- プロンプト変更だけでは解決できない根本的な問題

#### 6. Granite 1B: ❌ （⭐⭐から悪化）

**v19での状態**: ⭐⭐（重複と冗長性あるが一応成功）
**v20での状態**: ❌（Planning Phase完全失敗）

**v20での問題**:
- Planning Phaseで献立計画ではなく「パン作り」の手順を生成
- タスク理解の完全な崩壊
- 入力データ（冷蔵庫の材料、過去の献立）を完全に無視

**誤った出力例**:
```json
{
  "steps": [
    {
      "id": "step-1",
      "description": "Gather necessary ingredients and equipment",
      "guidelines": ["List all required ingredients from the menu", ...],
      "actions": [{
        "tool": "shopping",
        "params": {
          "items": ["flour", "sugar", "baking powder", ...]
        }
      }]
    },
    ...
  ]
}
```

**悪化の原因**:
- v20プロンプトが1Bモデルには複雑すぎる
- guidelines/constraintsの説明が理解できず、タスク自体を誤解
- より単純なv19プロンプトの方が適していた

---

#### 7. Gemma 270M: ❌ （変化なし）

**v19/v20共通の問題**: JSON生成能力の欠如

**問題の詳細**:
- "The code will be executed with a set of instructions." の無限繰り返し
- 約50回同じフレーズを繰り返して出力終了
- JSON形式の出力を完全に無視

**270Mモデルの限界**:
- 構造化出力自体が困難
- 複雑な指示の理解が不可能
- プロンプト変更では解決不可能

---

## 質的改善: Execution Phase

### 前ステップ情報の活用

v20では、execution-freeform.tsの改善により、前ステップの決定内容（guidelines/constraints含む）が適切にmaterialsセクションに含まれる:

**Step 2のプロンプト例（QwQ-Bakeneko v20）**:
```
Material: Previous step decision: step-1
ID: execution-decision-step-1

[Instructions]
冷蔵庫の材料を分析し主菜候補を抽出

**Guidelines:**
- 冷蔵庫のプロテイン材料を確認
- 過去3日の主菜と重複しない材料を選ぶ

**Constraints:**
- 豚バラ肉は直近2日連続使用のため除外
- 鶏もも肉は3日前使用済みだが調整可能

[Result]
まず、冷蔵庫のプロテイン材料を確認します...
（前ステップの推論と結果）
```

この構造により、モデルは：
1. 前ステップの指示（guidelines/constraints）を理解
2. 前ステップの推論プロセスを参照
3. 前ステップの結果を活用
4. **新しい内容のみを生成**（不適切な繰り返しを回避）

---

## Integration Phaseの品質

### v20での最終出力例（QwQ-Bakeneko）

```
**最終献立案**
**主菜**: 【卵のオムライス】
- **材料**: 卵6個・ご飯・玉ねぎ・ピーマン・人参・醤油・ごま油
- **調理**: オムライスの黄身を残して仕上げ、ごま油で風味アップ

**副菜**:
1. **人参ピーマンの甘辛炒め**
   - 材料: 人参・ピーマン・醤油・みりん・酒
   - 調理: 野菜を細切りにし、甘辛ダレで炒める
2. **玉ねぎわかめの酢の物**
   - 材料: 玉ねぎ・乾燥わかめ・酢・醤油・砂糖
   - 調理: 玉ねぎを薄切りにし、わかめと合わせて酢味噌で和える

**買い出しリスト**: 空（全て冷蔵庫在庫で対応可能）

**選定理由**:
- 過去3日間の豚肉・鶏肉料理から脱却
- 卵は冷蔵庫の在庫を効率活用
- 副菜で野菜摂取量を確保（人参・ピーマン・玉ねぎ）
```

**品質特徴**:
- ✅ 3つのステップ（主菜候補→副菜提案→不足材料確認）の結果を統合
- ✅ 具体的な献立（主菜1品+副菜2品）
- ✅ 材料リストと調理方法
- ✅ 過去の献立との重複回避を明記
- ✅ 買い出し不要を確認

---

## 主要な問題パターンの分析

### Planning Phaseの失敗パターン

1. **Granite 1B**: タスク理解の完全崩壊（献立計画 → パン作り手順）
2. **Gemma 270M**: JSON生成能力の欠如（無限ループ）

### Execution Phaseの問題パターン

1. **Granite Tiny 7B**: 全ステップで同一内容を繰り返す（"Do NOT copy"指示無視）
2. **QwQ-Bakeneko 32B**: `<think>`による大量トークン消費で出力途切れ（max_tokens調整が必要）

### Integration Phaseの品質

**成功モデルの共通点**:
- Planning phaseで生成したsteps構造を活用
- 各stepの結果を統合した最終出力
- 具体的な献立（主菜・副菜・買い出しリスト）

**失敗モデルの共通点**:
- Planning phase自体が失敗
- Integration phaseに到達できず

---

## 結論

### 主要な成果

1. **成功率14.3ポイント向上**（71.4% → 85.7%）
2. **QwQ-Bakeneko 32Bの完全復活**（⭐ → ⭐⭐⭐）
3. **Gemma 4B, LLM-JP 8x13Bの品質向上**（⭐⭐⭐ → ⭐⭐⭐⭐）
4. **用語の具体化による理解度向上**（全成功モデルで適切なguidelines/constraints生成）
5. **多言語環境での安定性向上**（英語慣用句から具体的日本語用語へ）

### 改善と悪化の内訳

**改善したモデル（3モデル）**:
- QwQ-Bakeneko 32B: ⭐ → ⭐⭐⭐⭐（**劇的改善** - 推論品質が非常に高い）
- Gemma 4B: ⭐⭐⭐ → ⭐⭐⭐⭐（改善）
- LLM-JP 8x13B: ⭐⭐⭐ → ⭐⭐⭐⭐（改善）

**変化なし（3モデル）**:
- Gemma 27B: ⭐⭐⭐⭐⭐ → ⭐⭐⭐⭐⭐（継続成功）
- Granite Tiny 7B: ⭐⭐⭐ → ⭐⭐⭐（問題継続）
- Gemma 270M: ❌ → ❌（継続失敗）

**悪化したモデル（1モデル）**:
- Granite 1B: ⭐⭐ → ❌（**悪化** - v20プロンプトが複雑すぎた）

### 重要な学び

1. **大規模モデルでも曖昧な用語は避けるべき**: 32BクラスのQwQ-Bakenekoでも、dos/dontsは混乱の原因
2. **具体的・直接的な用語が効果的**: guidelines（指針）、constraints（制約）は明確
3. **例文は混乱の原因**: ユーザー要求「説明にサンプルを含めないで」が正しかった
4. **4B以上では安定動作**: 適切な用語であれば、幅広いサイズで成功
5. **1B以下ではプロンプト簡素化が必要**: 複雑なプロンプトはタスク理解を妨げる

### モデルサイズごとの推奨プロンプト戦略

| サイズ | 推奨戦略 | 理由 |
|--------|---------|------|
| 30B+ | v20推奨 | 複雑な指示も理解可能、具体的用語で混乱回避 |
| 4-27B | v20推奨 | 安定した動作、品質向上の恩恵あり |
| 1-4B | v20を試行、問題あればv19 | モデルにより適合度が異なる |
| <1B | 極度に簡素化したプロンプト | v19/v20いずれも複雑すぎる |

### 今後の方向性

1. **Granite 1Bへの対応**:
   - v20より簡素なプロンプト構造の検討
   - guidelines/constraintsの説明をさらに簡略化
   - ステップ数削減（3ステップ程度）

2. **Gemma 270Mへの対応**:
   - 構造化出力を諦め、自由形式出力のみに限定
   - または、より高性能なモデルへの移行を推奨

3. **英語プロンプトでのv20テスト**:
   - guidelines/constraintsが英語環境でも有効か確認
   - v19英語結果との比較

4. **Granite Tiny 7Bの同一出力問題**:
   - プロンプト変更では解決困難
   - モデル自体の限界と判断
   - 英語プロンプトへの切り替えを推奨

5. **QwQ-Bakenekoの出力途切れ問題**:
   - max_tokensパラメータの増加（`<think>`による大量トークン消費を考慮）
   - MLXドライバー側で`<think>`タグ除外処理の実装を検討

---

## 付録: テスト実行情報

### 実行日時
- v19テスト: 2025-11-18
- v20テスト: 2025-11-19

### テストケース
- `experiments/agentic-workflow-model-comparison/test-cases/meal-planning.json`
- 日本語プロンプト、freeform execution mode

### 結果ファイル
- v19: `experiments/agentic-workflow-model-comparison/results/*-ja-freeform-v19.txt`
- v20: `experiments/agentic-workflow-model-comparison/results/*-ja-freeform-v20.txt`

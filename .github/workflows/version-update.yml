name: Version Update

on:
  push:
    branches:
      - 'release/**'

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check for changesets
      id: changesets
      run: |
        if [ -n "$(ls -A .changeset/*.md 2>/dev/null | grep -v README.md)" ]; then
          echo "has_changesets=true" >> $GITHUB_OUTPUT
        else
          echo "has_changesets=false" >> $GITHUB_OUTPUT
        fi

    - name: Apply version updates
      if: steps.changesets.outputs.has_changesets == 'true'
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

        # 1. changesetã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨CHANGELOGã‚’æ›´æ–°
        npx changeset version

        # 2. ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡ºã—ã¦rootã‚’æ›´æ–°
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"
        if [[ "$BRANCH_NAME" =~ ^release/([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
          VERSION="${BASH_REMATCH[1]}"
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "
          echo "Updated root package.json to version $VERSION"
        fi

        # 3. package-lock.jsonã‚’æ›´æ–°
        npm install --package-lock-only

        # 4. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»push
        if [ -n "$(git status --porcelain)" ]; then
          git add -A
          git commit -m "chore: version update via changeset"
          git push
        fi

    - name: Create or update PR
      if: steps.changesets.outputs.has_changesets == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        VERSION=$(node -p "require('./package.json').version")
        BRANCH_NAME="${GITHUB_REF#refs/heads/}"

        # PRãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
        PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --json number -q '.[0].number')

        if [ -z "$PR_NUMBER" ]; then
          # æ–°è¦PRä½œæˆ
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "Release v$VERSION" \
            --body "## ğŸš€ Release v$VERSION

        ã“ã®PRã¯release/$VERSIONãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®è‡ªå‹•ç”Ÿæˆã§ã™ã€‚

        ### å¤‰æ›´å†…å®¹
        - ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®æ›´æ–°
        - CHANGELOGã®è‡ªå‹•ç”Ÿæˆ

        ### ãƒãƒ¼ã‚¸å¾Œã®å‹•ä½œ
        - mainãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸æ™‚ã«è‡ªå‹•çš„ã«npmã¸å…¬é–‹ã•ã‚Œã¾ã™

        ### ç¢ºèªäº‹é …
        - [ ] CHANGELOGã®å†…å®¹ãŒæ­£ã—ã„ã‹
        - [ ] ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ãŒæ­£ã—ã„ã‹
        - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã‹"
        else
          echo "PR #$PR_NUMBER already exists for $BRANCH_NAME"
        fi

    - name: No changesets found
      if: steps.changesets.outputs.has_changesets == 'false'
      run: |
        echo "âš ï¸ .changesetãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«changesetãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        echo "ãƒªãƒªãƒ¼ã‚¹å‰ã« 'npx changeset' ã§å¤‰æ›´å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„"
        exit 1

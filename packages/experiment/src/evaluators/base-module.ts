/**
 * Base evaluation prompt module
 *
 * This module provides the foundation for all evaluation prompts.
 * It defines how test data is presented to the evaluator.
 */

import type { PromptModule, TextElement, JSONElement } from '@modular-prompt/core';
import type { EvaluationContext } from '../types.js';

export const baseEvaluationModule: PromptModule<EvaluationContext> = {
  createContext: (): EvaluationContext => ({
    moduleName: '',
    prompt: '',
    runs: [],
  }),

  objective: [
    '- Evaluate the output of a prompt module',
    '- Provide detailed assessment with scores and reasoning',
  ],

  terms: [
    '- Module: A prompt variation being tested',
    '- Prompt: The compiled prompt used to generate the output',
    '- Query Result: The output generated by the LLM',
    '- Run: A single execution of the prompt',
  ],

  instructions: [
    {
      type: 'subsection',
      title: 'Output Format',
      items: [
        'Return evaluation in JSON format with the following structure:',
        '- score: Overall score (0-10)',
        '- reasoning: Clear explanation of the score',
        '- details: Object with additional evaluation metrics',
      ],
    },
  ],

  materials: [
    {
      type: 'subsection',
      title: 'Module Name',
      items: [
        (ctx) => ctx.moduleName,
      ],
    },
    {
      type: 'subsection',
      title: 'Prompt Used',
      items: [
        (ctx) => ({
          type: 'text',
          content: ctx.prompt,
        } as TextElement),
      ],
    },
  ],

  inputs: [
    (ctx) => ctx.runs.flatMap((run, idx) => {
      const result = run.queryResult;
      const elements: Array<TextElement | JSONElement> = [];

      // Run number
      elements.push({
        type: 'text',
        content: `Run ${idx + 1}`,
      });

      // Output (prefer structuredOutput over content)
      if (result.structuredOutput) {
        elements.push({
          type: 'json',
          content: result.structuredOutput,
        });
      } else {
        elements.push({
          type: 'text',
          content: result.content,
        });
      }

      return elements;
    }),
  ],

  schema: [
    {
      type: 'json',
      content: {
        type: 'object',
        properties: {
          score: {
            type: 'number',
            description: 'Overall score (0-10)',
          },
          reasoning: {
            type: 'string',
            description: 'Explanation of the score',
          },
          details: {
            type: 'object',
            description: 'Additional evaluation metrics',
          },
        },
        required: ['score', 'reasoning'],
      },
    },
  ],
};
